{% extends 'base.html' %}
{% load usuarios_extras %}

{% load crispy_forms_tags %}
{% load static %}

{% block title %}Lista de Consultas programadas{% endblock %}

{% block page_title %}Gestión de Consultas Programadas{% endblock %}

{% block extra_css %}
<style>
    .citas-header {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(108, 117, 125, 0.1) 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(220, 53, 69, 0.1);
        position: relative;
        overflow: hidden;
    }

    .citas-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(220, 53, 69, 0.05) 0%, transparent 50%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .citas-header-content {
        position: relative;
        z-index: 2;
    }

    .citas-title {
        font-size: 2.25rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .citas-title .icon {
        font-size: 2.5rem;
        background: linear-gradient(45deg, #dc3545, #6c757d);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .citas-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
        margin: 0;
    }

    .add-cita-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 0.875rem 1.75rem;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .add-cita-btn:hover {
        background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }

    .filters-section {
        background: #ffffff;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .filters-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(220, 53, 69, 0.1);
    }

    .filters-header h5 {
        margin: 0;
        color: #212529;
        font-weight: 600;
    }

    .filters-header i {
        color: #dc3545;
        font-size: 1.2rem;
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1rem;
        transition: var(--transition);
        font-size: 0.95rem;
        background: #f8f9fa;
    }

    .form-control:focus, .form-select:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        background: white;
        outline: none;
    }

    .form-label {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.5rem;
    }

    .filter-btn {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .filter-btn:hover {
        background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }

    .clear-btn {
        background: transparent;
        color: #6c757d;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        transition: var(--transition);
    }

    .clear-btn:hover {
        background: #f8f9fa;
        border-color: #6c757d;
        color: #212529;
    }

    .citas-table-container {
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .table-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .citas-table {
        margin: 0;
    }

    .citas-table thead th {
        background: rgba(220, 53, 69, 0.05);
        color: #212529;
        font-weight: 600;
        border: none;
        padding: 1rem 1.5rem;
        position: relative;
    }

    .citas-table thead th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #dc3545, transparent);
    }

    .citas-table tbody tr {
        transition: var(--transition);
        border: none;
    }

    .citas-table tbody tr:hover {
        background: rgba(220, 53, 69, 0.03);
        transform: scale(1.01);
    }

    .citas-table tbody tr.pending-row {
        background: rgba(255, 193, 7, 0.05);
        border-left: 4px solid #ffc107;
    }

    .citas-table tbody tr.pending-row:hover {
        background: rgba(255, 193, 7, 0.08);
        transform: scale(1.01);
    }

    .citas-table tbody td {
        padding: 1.25rem 1.5rem;
        border: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        vertical-align: middle;
    }

    .mascota-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .mascota-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #dc3545, #6c757d);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .mascota-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .mascota-name {
        font-weight: 600;
        color: #212529;
        font-size: 1rem;
        margin: 0;
    }

    .mascota-breed {
        color: #6c757d;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mascota-breed i {
        width: 16px;
        text-align: center;
        color: #dc3545;
    }

    .propietario-name {
        color: #212529;
        font-weight: 500;
    }

    .fecha-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .fecha-principal {
        font-weight: 600;
        color: #212529;
    }

    .hora-detalle {
        color: #6c757d;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .hora-detalle i {
        width: 16px;
        text-align: center;
        color: #dc3545;
    }

    .motivo-text {
        color: #212529;
        line-height: 1.4;
    }

    .tipo-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .tipo-badge.programada {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .tipo-badge.urgencia {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .estado-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.3rem 0.7rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .estado-badge.atendida {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .estado-badge.pendiente {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-action {
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: var(--transition);
        font-size: 0.85rem;
        padding: 0 0.75rem;
        text-decoration: none;
        font-weight: 500;
    }

    .btn-action.view {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
        border: 1px solid rgba(108, 117, 125, 0.2);
    }

    .btn-action.view:hover {
        background: #6c757d;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .btn-action.atender {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
        gap: 0.5rem;
    }

    .btn-action.atender:hover {
        background: #28a745;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-action.consulta {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
        gap: 0.5rem;
    }

    .btn-action.consulta:hover {
        background: #dc3545;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .btn-action.edit {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .btn-action.edit:hover {
        background: #ffc107;
        color: #212529;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    .btn-action.delete {
        background: rgba(52, 58, 64, 0.1);
        color: #343a40;
        border: 1px solid rgba(52, 58, 64, 0.2);
    }

    .btn-action.delete:hover {
        background: #343a40;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(52, 58, 64, 0.3);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 4rem;
        color: rgba(220, 53, 69, 0.2);
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #212529;
        margin-bottom: 0.5rem;
    }

    .search-filter-section {
        background: #ffffff;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .search-box {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 3rem;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: #f8f9fa;
    }

    .search-input:focus {
        outline: none;
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1.1rem;
    }

    .filter-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .filter-tag {
        background: linear-gradient(135deg, #dc3545, #b02a37);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .filter-tag .remove-tag {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        margin-left: 0.25rem;
    }

    .filter-tag .remove-tag:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .no-results {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        background: rgba(0, 0, 0, 0.02);
    }
    
    /* Estilos para botones de acción adicionales */
    .btn-action.phone {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }

    .btn-action.phone:hover {
        background: linear-gradient(45deg, #218838, #1ea888);
        transform: translateY(-2px) scale(1.05);
    }

    .btn-action.success {
        background: linear-gradient(45deg, #17a2b8, #138496);
        color: white;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
    }

    .btn-action.success:hover {
        background: linear-gradient(45deg, #138496, #117a8b);
    }

    /* Animaciones para las nuevas filas */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out forwards;
    }

    /* Estilos para indicadores de fecha */
    .fecha-info small {
        display: block;
        margin-top: 0.25rem;
        font-weight: 500;
    }

    /* Responsive para las nuevas tablas */
    @media (max-width: 768px) {
        .btn-action.success {
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 0.3rem;
        }
    }

    /* Colores específicos para vacunas y productos */
    .vacuna-row:hover {
        background: linear-gradient(90deg, rgba(0, 123, 255, 0.05), rgba(0, 123, 255, 0.02)) !important;
    }

    .producto-row:hover {
        background: linear-gradient(90deg, rgba(23, 162, 184, 0.05), rgba(23, 162, 184, 0.02)) !important;
    }

    .mascota-link {
        color: #dc3545;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .mascota-link:hover {
        color: #dc3545;
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .citas-title {
            font-size: 1.75rem;
        }
        
        .filters-section {
            padding: 1rem;
        }
        
        .table-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 0.25rem;
        }
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .slide-up {
        animation: slideUp 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header Section -->
    <div class="citas-header">
        <div class="citas-header-content">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 class="citas-title">
                        <i class="fas fa-calendar-check icon"></i>
                        Consultas Programadas
                    </h1>
                    <p class="citas-subtitle">
                        Lista diaria de consultas, vacunas y desparasitantes pendientes por atender
                    </p>
                </div>
                <a href="{% url 'consultas:crear_cita' %}" class="add-cita-btn hover-lift">
                    <i class="fas fa-plus"></i>
                    Nueva Consulta
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section slide-up">
        <div class="filters-header">
            <i class="fas fa-filter"></i>
            <h5>Filtros de Búsqueda</h5>
        </div>
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <label for="fecha" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Fecha
                </label>
                <input type="date" class="form-control" id="fecha" name="fecha" value="{{ request.GET.fecha|default:'' }}">
            </div>
        
            <div class="col-md-6 d-flex align-items-end gap-2">
                <button type="submit" class="filter-btn">
                    <i class="fas fa-search me-1"></i>Filtrar
                </button>
                <a href="{% url 'consultas:lista_citas' %}" class="clear-btn">
                    <i class="fas fa-eraser me-1"></i>Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Search Section -->
    <div class="search-filter-section slide-up">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar consultas por mascota, cliente, motivo, especie o raza..." id="searchInput">
                </div>
            </div>
        </div>
        <div class="filter-tags" id="filterTags">
            <!-- Los tags de filtro aparecerán aquí dinámicamente -->
        </div>
    </div>

    <!-- Table Section -->
    <div class="citas-table-container slide-up">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-list"></i>
                Lista de Consultas programadas
            </h3>
            <span class="text-white-50">Total: <strong id="resultCount">{{ total_pendientes }}</strong> elementos pendientes</span>
        </div>
        
        {% if citas %}
        <div class="table-responsive">
            <table class="table citas-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-paw me-1"></i>Mascota</th>
                        <th><i class="fas fa-user me-1"></i>Propietario</th>
                        <th><i class="fas fa-calendar me-1"></i>Fecha</th>
                        <th><i class="fas fa-clipboard-list me-1"></i>Motivo</th>
                        <th><i class="fas fa-info-circle me-1"></i>Estado</th>
                        <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cita in citas %}
                    <tr class="{% if not cita.atendida %}pending-row{% endif %} cita-row" 
                        data-mascota-name="{{ cita.mascota.nombre|lower }}"
                        data-cliente-name="{{ cita.mascota.cliente.nombre|lower }}"
                        data-especie="{{ cita.mascota.especie.nombre|lower }}"
                        data-raza="{{ cita.mascota.raza.nombre|lower }}"
                        data-motivo="{{ cita.motivo|lower }}"
                        data-estado="{% if cita.atendida %}atendida{% else %}pendiente{% endif %}"
                        >
                        <td>
                            <div class="mascota-info">
                                <div class="mascota-name">
                                    <a href="{% url 'clientes:detalle_mascota' cita.mascota.id %}" class="mascota-link">
                                        {{ cita.mascota.nombre }}
                                    </a>
                                </div>
                                <div class="mascota-details">
                                    <span>{{ cita.mascota.especie }} - {{ cita.mascota.raza }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="propietario-name">{{ cita.mascota.cliente.nombre }}</div>
                            <div class="text-muted small">{{ cita.mascota.cliente.telefono }}</div>
                        </td>
                        <td>
                            <div class="fecha-info">
                                <div class="fecha-principal">{{ cita.fecha|date:"d/m/Y" }}</div>
                            </div>
                        </td>
                        <td>
                            <div class="motivo-text">{{ cita.motivo|truncatechars:40 }}</div>
                        </td>
                        
                        <td>
                            {% if cita.atendida %}
                            <span class="estado-badge atendida">
                                <i class="fas fa-check-circle"></i>
                                Atendida
                            </span>
                            {% else %}
                            <span class="estado-badge pendiente">
                                <i class="fas fa-clock"></i>
                                Pendiente
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'consultas:detalle_cita' cita.id %}" 
                                   class="btn-action view" 
                                   title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if not cita.atendida %}
                                <a href="{% url 'consultas:crear_consulta' cita.id %}" 
                                   class="btn-action atender" 
                                   title="Atender cita">
                                    <i class="fas fa-stethoscope"></i>
                                    Atender
                                </a>
                                {% else %}
                                    {% with primera_consulta=cita.consultas.first %}
                                    {% if primera_consulta %}
                                    <a href="{% url 'consultas:detalle_consulta' primera_consulta.id %}" 
                                       class="btn-action consulta" 
                                       title="Ver consulta">
                                        <i class="fas fa-file-medical"></i>
                                        Ver Consulta
                                    </a>
                                    {% else %}
                                    <span class="btn-action consulta disabled" title="Consulta no disponible">
                                        <i class="fas fa-file-medical"></i>
                                        Sin Consulta
                                    </span>
                                    {% endif %}
                                    {% endwith %}
                                {% endif %}
                                
                                <a href="{% url 'consultas:editar_cita' cita.id %}" 
                                   class="btn-action edit" 
                                   title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>

                                {% if request.user|puede_eliminar %}
                                    <a href="{% url 'consultas:eliminar_cita' cita.id %}" 
                                        class="btn-action delete" 
                                        title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h3>No hay consultas registradas</h3>
            <p>Comienza programando la primera consulta</p>
            <a href="{% url 'consultas:crear_cita' %}" class="add-cita-btn">
                <i class="fas fa-plus"></i>
                Programar Primera Consulta
            </a>
        </div>
        {% endif %}

        {% if vacunas_agendadas %}
        <div class="citas-table-container slide-up mt-4">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-syringe"></i>
                    Vacunas Agendadas
                </h3>
                <span class="text-white-50">Total: <strong>{{ vacunas_agendadas.paginator.count }}</strong> vacunas pendientes</span>
            </div>
            
            <div class="table-responsive">
                <table class="table citas-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-paw me-1"></i>Mascota</th>
                            <th><i class="fas fa-user me-1"></i>Propietario</th>
                            <th><i class="fas fa-syringe me-1"></i>Vacuna</th>
                            <th><i class="fas fa-calendar me-1"></i>Fecha Agendada</th>
                            <th><i class="fas fa-sticky-note me-1"></i>Observaciones</th>
                            <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vacuna in vacunas_agendadas %}
                        <tr class="pending-row vacuna-row fade-in" 
                            data-mascota-name="{{ vacuna.mascota.nombre|lower }}"
                            data-cliente-name="{{ vacuna.mascota.cliente.nombre|lower }}"
                            data-vacuna="{{ vacuna.vacuna.nombre|lower }}"
                            data-fecha="{{ vacuna.fecha_proxima|date:'Y-m-d' }}"
                            style="animation-delay: {{ forloop.counter|floatformat:2|add:'s' }}">
                            
                            <td>
                                <div class="mascota-info">
                                    <div class="mascota-name">
                                        <a href="{% url 'clientes:detalle_mascota' vacuna.mascota.id %}" class="mascota-link">
                                            {{ vacuna.mascota.nombre }}
                                        </a>
                                    </div>
                                    <div class="mascota-details">
                                        <span>{{ vacuna.mascota.especie }} - {{ vacuna.mascota.raza }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="propietario-name">{{ vacuna.mascota.cliente.nombre }}</div>
                                <div class="text-muted small">{{ vacuna.mascota.cliente.telefono }}</div>
                            </td>
                            <td>
                                <div class="fw-bold text-primary">{{ vacuna.vacuna.nombre }}</div>
                                {% if vacuna.vacuna.descripcion %}
                                <div class="text-muted small">{{ vacuna.vacuna.descripcion|truncatechars:30 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fecha-info">
                                    <div class="fecha-principal">{{ vacuna.fecha_proxima|date:"d/m/Y" }}</div>
                                    {% now 'Y-m-d' as today %}
                                    {% if vacuna.fecha_proxima|date:'Y-m-d' < today %}
                                    <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Vencida</small>
                                    {% elif vacuna.fecha_proxima|date:'Y-m-d' == today %}
                                    <small class="text-warning"><i class="fas fa-clock"></i> Hoy</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="observaciones-text">
                                    {{ vacuna.observaciones|default:"Sin observaciones"|truncatechars:40 }}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'clientes:detalle_mascota' vacuna.mascota.id %}" 
                                    class="btn-action view" 
                                    title="Ver mascota">
                                        <i class="fas fa-paw"></i>
                                    </a>
                                    <a href="#" onclick="llamarCliente('{{ vacuna.mascota.cliente.telefono }}', '{{ vacuna.mascota.cliente.nombre }}')" 
                                    class="btn-action phone" 
                                    title="Llamar cliente">
                                        <i class="fas fa-phone"></i>
                                    </a>
                                    <a href="{% url 'inventario:aplicar_vacuna' vacuna.id %}" 
                                    class="btn-action success" 
                                    title="Aplicar vacuna">
                                        <i class="fas fa-check"></i>
                                        Aplicar
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación para vacunas -->
            {% if vacunas_agendadas.has_other_pages %}
            <nav aria-label="Paginación de vacunas" class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if vacunas_agendadas.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}vacunas_page={{ vacunas_agendadas.previous_page_number }}">Anterior</a>
                        </li>
                    {% endif %}
                    
                    {% for num in vacunas_agendadas.paginator.page_range %}
                        {% if vacunas_agendadas.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > vacunas_agendadas.number|add:'-3' and num < vacunas_agendadas.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}vacunas_page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if vacunas_agendadas.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}vacunas_page={{ vacunas_agendadas.next_page_number }}">Siguiente</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
        {% endif %}

        <!-- TABLA DE PRODUCTOS AGENDADOS -->
        {% if productos_agendados %}
        <div class="citas-table-container slide-up mt-4">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-pills"></i>
                    Productos Agendados
                </h3>
                <span class="text-white-50">Total: <strong>{{ productos_agendados.paginator.count }}</strong> productos pendientes</span>
            </div>
            
            <div class="table-responsive">
                <table class="table citas-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-paw me-1"></i>Mascota</th>
                            <th><i class="fas fa-user me-1"></i>Propietario</th>
                            <th><i class="fas fa-pills me-1"></i>Producto</th>
                            <th><i class="fas fa-calendar me-1"></i>Fecha Agendada</th>
                            <th><i class="fas fa-sticky-note me-1"></i>Observaciones</th>
                            <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos_agendados %}
                        <tr class="pending-row producto-row fade-in" 
                            data-mascota-name="{{ producto.mascota.nombre|lower }}"
                            data-cliente-name="{{ producto.mascota.cliente.nombre|lower }}"
                            data-producto="{{ producto.producto.nombre|lower }}"
                            data-fecha="{{ producto.fecha_proxima|date:'Y-m-d' }}"
                            style="animation-delay: {{ forloop.counter|floatformat:2|add:'s' }}">
                            
                            <td>
                                <div class="mascota-info">
                                    <div class="mascota-name">
                                        <a href="{% url 'clientes:detalle_mascota' producto.mascota.id %}" class="mascota-link">
                                            {{ producto.mascota.nombre }}
                                        </a>
                                    </div>
                                    <div class="mascota-details">
                                        <span>{{ producto.mascota.especie }} - {{ producto.mascota.raza }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="propietario-name">{{ producto.mascota.cliente.nombre }}</div>
                                <div class="text-muted small">{{ producto.mascota.cliente.telefono }}</div>
                            </td>
                            <td>
                                <div class="fw-bold text-info">{{ producto.producto.nombre }}</div>
                                <div class="text-muted small">
                                    <i class="fas fa-tag me-1"></i>{{ producto.producto.get_tipo_display }}
                                </div>
                            </td>
                            <td>
                                <div class="fecha-info">
                                    <div class="fecha-principal">{{ producto.fecha_proxima|date:"d/m/Y" }}</div>
                                    {% now 'Y-m-d' as today %}
                                    {% if producto.fecha_proxima|date:'Y-m-d' < today %}
                                    <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Vencida</small>
                                    {% elif producto.fecha_proxima|date:'Y-m-d' == today %}
                                    <small class="text-warning"><i class="fas fa-clock"></i> Hoy</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="observaciones-text">
                                    {{ producto.observaciones|default:"Sin observaciones"|truncatechars:40 }}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'clientes:detalle_mascota' producto.mascota.id %}" 
                                    class="btn-action view" 
                                    title="Ver mascota">
                                        <i class="fas fa-paw"></i>
                                    </a>
                                    <a href="#" onclick="llamarCliente('{{ producto.mascota.cliente.telefono }}', '{{ producto.mascota.cliente.nombre }}')" 
                                    class="btn-action phone" 
                                    title="Llamar cliente">
                                        <i class="fas fa-phone"></i>
                                    </a>
                                    <a href="{% url 'inventario:aplicar_producto' producto.id %}" 
                                    class="btn-action success" 
                                    title="Aplicar producto">
                                        <i class="fas fa-check"></i>
                                        Aplicar
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación para productos -->
            {% if productos_agendados.has_other_pages %}
            <nav aria-label="Paginación de productos" class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if productos_agendados.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}productos_page={{ productos_agendados.previous_page_number }}">Anterior</a>
                        </li>
                    {% endif %}
                    
                    {% for num in productos_agendados.paginator.page_range %}
                        {% if productos_agendados.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > productos_agendados.number|add:'-3' and num < productos_agendados.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}productos_page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if productos_agendados.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET.fecha %}fecha={{ request.GET.fecha }}&{% endif %}productos_page={{ productos_agendados.next_page_number }}">Siguiente</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const searchInput = document.getElementById('searchInput');
    const citaRows = document.querySelectorAll('.cita-row');
    const filterTagsContainer = document.getElementById('filterTags');
    const tableCountElement = document.getElementById('resultCount');
    
    let currentFilters = {
        search: '',
        estado: '' 
    };

    // Función principal de búsqueda
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentFilters.search = this.value.toLowerCase();
            applyAllFilters();
        }, 300);
    });
    
    // Función para aplicar todos los filtros
    function applyAllFilters() {
        let visibleCount = 0;
        
        citaRows.forEach(row => {
            const mascotaName = row.dataset.mascotaName || '';
            const clienteName = row.dataset.clienteName || '';
            const especie = row.dataset.especie || '';
            const raza = row.dataset.raza || '';
            const motivo = row.dataset.motivo || '';
            const estado = row.dataset.estado || '';
            
            
            // Verificar filtro de búsqueda
            const matchesSearch = !currentFilters.search || 
                mascotaName.includes(currentFilters.search) || 
                clienteName.includes(currentFilters.search) || 
                especie.includes(currentFilters.search) || 
                raza.includes(currentFilters.search) || 
                motivo.includes(currentFilters.search);
            
            // Verificar filtro de estado
            const matchesEstado = !currentFilters.estado || 
                estado === currentFilters.estado;
            
            // Mostrar/ocultar fila
            const isVisible = matchesSearch && matchesEstado;
            
            if (isVisible) {
                row.style.display = '';
                row.style.animation = 'fadeIn 0.3s ease-in';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        updateResultsCount(visibleCount);
        updateFilterTags();
        showNoResultsMessage(visibleCount);
    }
    
    // Actualizar contador de resultados
    function updateResultsCount(count) {
        if (tableCountElement) {
            tableCountElement.textContent = count;
        }
    }
    
    // Mostrar mensaje de sin resultados
    function showNoResultsMessage(count) {
        const tableBody = document.querySelector('.citas-table tbody');
        let noResultsRow = document.getElementById('noResultsRow');
        
        if (count === 0 && tableBody) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.innerHTML = `
                    <td colspan="6" class="no-results">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <div>No se encontraron consultas que coincidan con los criterios de búsqueda.</div>
                        <small style="margin-top: 0.5rem; display: block;">Intenta con otros términos o limpia los filtros.</small>
                    </td>
                `;
                tableBody.appendChild(noResultsRow);
            }
            noResultsRow.style.display = '';
        } else if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }
    
    // Actualizar tags de filtros activos
    function updateFilterTags() {
        if (!filterTagsContainer) return;
        
        filterTagsContainer.innerHTML = '';
        
        // Tag de búsqueda
        if (currentFilters.search) {
            addFilterTag(`Búsqueda: "${currentFilters.search}"`, 'search');
        }
        
        // Tag de estado
        if (currentFilters.estado) {
            const estadoText = currentFilters.estado === 'atendida' ? 'Atendidas' : 'Pendientes';
            addFilterTag(`Estado: ${estadoText}`, 'estado');
        }
    }
    
    // Añadir tag de filtro
    function addFilterTag(text, filterType) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `
            ${text}
            <span class="remove-tag" onclick="removeFilter('${filterType}')">
                <i class="fas fa-times"></i>
            </span>
        `;
        filterTagsContainer.appendChild(tag);
    }
    
    // Funciones globales para los filtros
    window.removeFilter = function(filterType) {
        switch(filterType) {
            case 'search':
                currentFilters.search = '';
                searchInput.value = '';
                break;
            case 'estado':
                currentFilters.estado = '';
                break;
        }
        applyAllFilters();
    };
    
    window.filterByEstado = function(estado) {
        currentFilters.estado = estado;
        applyAllFilters();
    };
    
    window.clearAllFilters = function() {
        currentFilters = {
            search: '',
            estado: ''
        };
        searchInput.value = '';
        applyAllFilters();
    };
    
    // Mejorar efectos hover para filas
    citaRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            if (this.style.display !== 'none') {
                this.style.transform = 'scale(1.01)';
                this.style.boxShadow = '0 4px 20px rgba(220, 53, 69, 0.1)';
            }
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
    
    // Soporte para teclas de acceso rápido
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + F para enfocar el buscador
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
            searchInput.select();
        }
        
        // Escape para limpiar filtros
        if (e.key === 'Escape') {
            clearAllFilters();
        }
    });
    
    // Animaciones para las filas existentes
    document.querySelectorAll('.citas-table tbody tr').forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('slide-up');
    });
    
    // Enhanced hover effects for action buttons
    document.querySelectorAll('.btn-action').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.05)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });

    // Funciones para las nuevas tablas
    const vacunaRows = document.querySelectorAll('.vacuna-row');
    const productoRows = document.querySelectorAll('.producto-row');
    
    // Expandir la búsqueda para incluir vacunas y productos
    function applySearchToAllTables() {
        const searchTerm = searchInput.value.toLowerCase();
        
        // Búsqueda en vacunas
        vacunaRows.forEach(row => {
            const mascotaName = row.dataset.mascotaName || '';
            const clienteName = row.dataset.clienteName || '';
            const vacuna = row.dataset.vacuna || '';
            
            const matches = mascotaName.includes(searchTerm) || 
                           clienteName.includes(searchTerm) || 
                           vacuna.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
        });
        
        // Búsqueda en productos
        productoRows.forEach(row => {
            const mascotaName = row.dataset.mascotaName || '';
            const clienteName = row.dataset.clienteName || '';
            const producto = row.dataset.producto || '';
            
            const matches = mascotaName.includes(searchTerm) || 
                           clienteName.includes(searchTerm) || 
                           producto.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
        });
    }
    
    // Actualizar la función de búsqueda existente
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentFilters.search = this.value.toLowerCase();
            applyAllFilters();
            applySearchToAllTables(); // Agregar esta línea
        }, 300);
    });
    
    // Efectos hover para las nuevas filas
    [...vacunaRows, ...productoRows].forEach(row => {
        row.addEventListener('mouseenter', function() {
            if (this.style.display !== 'none') {
                this.style.transform = 'scale(1.01)';
                this.style.boxShadow = '0 4px 20px rgba(0, 123, 255, 0.1)';
            }
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });

    // Función para llamar clientes 
    window.llamarCliente = function(telefono, nombre) {
        if (telefono) {
            // Intentar abrir la app de teléfono
            window.location.href = `tel:${telefono}`;
            
            // Mostrar notificación
            if (typeof toastr !== 'undefined') {
                toastr.info(`Llamando a ${nombre}: ${telefono}`);
            } else {
                alert(`Llamando a ${nombre}: ${telefono}`);
            }
        } else {
            if (typeof toastr !== 'undefined') {
                toastr.warning('Este cliente no tiene teléfono registrado');
            } else {
                alert('Este cliente no tiene teléfono registrado');
            }
        }
    };
    
    // Inicializar la tabla
    updateResultsCount(citaRows.length);
    
    console.log('🔍 Sistema de filtros y búsqueda de citas inicializado correctamente');
});
</script>
{% endblock %}