{% extends 'base.html' %}
{% load static %}

{% block title %}Historia Clínica - {{ mascota.nombre }}{% endblock %}

{% block page_title %}Historia Clínica - {{ mascota.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .clinic-history-header {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(255, 255, 255, 0.1) 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(220, 53, 69, 0.15);
        position: relative;
        overflow: hidden;
    }

    .clinic-history-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(220, 53, 69, 0.08) 0%, transparent 50%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .clinic-history-header-content {
        position: relative;
        z-index: 2;
    }

    .breadcrumb-modern {
        background: #ffffff;
        border-radius: var(--border-radius);
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.1);
    }

    .breadcrumb-modern .breadcrumb {
        margin: 0;
        background: none;
        padding: 0;
    }

    .breadcrumb-modern .breadcrumb-item {
        font-size: 0.95rem;
    }

    .breadcrumb-modern .breadcrumb-item a {
        color: #dc3545;
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
    }

    .breadcrumb-modern .breadcrumb-item a:hover {
        color: #b02a37;
    }

    .breadcrumb-modern .breadcrumb-item.active {
        color: #333333;
        font-weight: 600;
    }

    .detail-card {
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.08);
        border: 1px solid rgba(220, 53, 69, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
        transition: var(--transition);
    }

    .detail-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(220, 53, 69, 0.15);
    }

    .card-header-modern {
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
        color: white;
        padding: 1.5rem 2rem;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .card-header-modern.bg-primary-custom {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .card-header-modern.bg-success-custom {
        background: linear-gradient(135deg, #dc3545 0%, #a71e2a 100%);
    }

    .card-header-modern.bg-info-custom {
        background: linear-gradient(135deg, #dc3545 0%, #c13043 100%);
    }

    .card-header-modern.bg-warning-custom {
        background: linear-gradient(135deg, #dc3545 0%, #b8222e 100%);
    }

    .card-header-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 0%, rgba(255, 255, 255, 0.15) 50%, transparent 100%);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .detail-card:hover .card-header-modern::before {
        transform: translateX(100%);
    }

    .card-title-modern {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        z-index: 2;
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .btn-modern {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        border: none;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-modern.btn-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-modern.btn-secondary:hover {
        background: #333333;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(51, 51, 51, 0.3);
    }

    .btn-modern.btn-primary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-modern.btn-primary:hover {
        background: #dc3545;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .card-body-modern {
        padding: 2rem;
        background: #ffffff;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1.5rem;
        background: rgba(220, 53, 69, 0.02);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid #dc3545;
        transition: var(--transition);
    }

    .info-item:hover {
        background: rgba(220, 53, 69, 0.05);
        transform: translateX(4px);
    }

    .info-label {
        font-weight: 600;
        color: #333333;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-label i {
        color: #dc3545;
        font-size: 1rem;
    }

    .info-value {
        font-size: 1.1rem;
        color: #666666;
        font-weight: 500;
        word-break: break-word;
    }

    .photo-card {
        background: #ffffff;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.08);
        text-align: center;
        border: 1px solid rgba(220, 53, 69, 0.1);
        transition: var(--transition);
        height: fit-content;
    }

    .photo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(220, 53, 69, 0.15);
    }

    .pet-photo {
        max-height: 200px;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.15);
        transition: var(--transition);
    }

    .pet-photo:hover {
        transform: scale(1.02);
    }

    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .status-active {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .status-inactive {
        background: rgba(51, 51, 51, 0.1);
        color: #333333;
        border: 1px solid rgba(51, 51, 51, 0.2);
    }

    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #dc3545, #b02a37);
        border-radius: 1px;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        padding-left: 1.5rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -0.5rem;
        top: 1.5rem;
        width: 12px;
        height: 12px;
        background: #dc3545;
        border: 3px solid #ffffff;
        border-radius: 50%;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    .timeline-consultation::before {
        background: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    .timeline-vaccine::before {
        background: #b02a37;
        box-shadow: 0 0 0 3px rgba(176, 42, 55, 0.2);
    }

    .timeline-product::before {
        background: #333333;
        box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.2);
    }

    .timeline-image::before {
        background: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    .timeline-card {
        background: #ffffff;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.08);
        border: 1px solid rgba(220, 53, 69, 0.1);
        overflow: hidden;
        transition: var(--transition);
    }

    .timeline-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(220, 53, 69, 0.15);
    }

    .timeline-card-header {
        padding: 1rem 1.5rem;
        color: white;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .timeline-card-header.consultation {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .timeline-card-header.vaccine {
        background: linear-gradient(135deg, #b02a37, #9c1f2e);
    }

    .timeline-card-header.product {
        background: linear-gradient(135deg, #333333, #1a1a1a);
        color: white;
    }

    .timeline-card-header.image {
        background: linear-gradient(135deg, #dc3545, #b02a37);
    }

    .timeline-card-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 0%, rgba(255, 255, 255, 0.15) 50%, transparent 100%);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .timeline-card:hover .timeline-card-header::before {
        transform: translateX(100%);
    }

    .timeline-card-body {
        padding: 1.5rem;
    }

    .timeline-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .timeline-info-item {
        background: rgba(220, 53, 69, 0.02);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        border-left: 3px solid #dc3545;
    }

    .timeline-info-label {
        font-weight: 600;
        color: #333333;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .timeline-info-value {
        color: #666666;
        font-weight: 500;
    }

    .alert-modern {
        border: none;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }

    .alert-info-modern {
        background: rgba(220, 53, 69, 0.08);
        color: #dc3545;
        border-left: 4px solid #dc3545;
    }

    .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .image-item {
        background: #ffffff;
        border-radius: var(--border-radius-sm);
        padding: 1rem;
        text-align: center;
        border: 1px solid rgba(220, 53, 69, 0.1);
        transition: var(--transition);
    }

    .image-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.1);
    }

    .image-preview {
        max-height: 150px;
        border-radius: var(--border-radius-sm);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.1);
    }

    .file-icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .btn-group-modern {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm-modern {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        border-radius: var(--border-radius-sm);
        font-weight: 500;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn-light-modern {
        background: rgba(255, 255, 255, 0.9);
        color: #333333;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-light-modern:hover {
        background: white;
        color: #dc3545;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        background: rgba(220, 53, 69, 0.02);
        border-radius: var(--border-radius);
        border: 2px dashed rgba(220, 53, 69, 0.2);
    }

    .empty-state-icon {
        font-size: 3rem;
        color: rgba(220, 53, 69, 0.3);
        margin-bottom: 1rem;
    }

    .section-divider {
        height: 2px;
        background: linear-gradient(90deg, transparent, #dc3545, transparent);
        margin: 3rem 0;
        border-radius: 1px;
    }

    @media print {
        .btn-modern, .card-actions, .breadcrumb-modern {
            display: none !important;
        }
        
        .detail-card {
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .timeline::before {
            background: #ddd !important;
        }
    }

    @media (max-width: 768px) {
        .clinic-history-header {
            padding: 1.5rem;
        }

        .card-header-modern {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .card-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .timeline-info-grid {
            grid-template-columns: 1fr;
        }

        .images-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .timeline {
            padding-left: 1rem;
        }

        .timeline-item {
            padding-left: 1rem;
        }
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .slide-up {
        animation: slideUp 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header de Historia Clínica -->
    <div class="clinic-history-header slide-up">
        <div class="clinic-history-header-content">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-file-medical me-3 text-secondary"></i>
                        Historia Clínica
                    </h1>
                    <p class="mb-0 text-muted">
                        <i class="fas fa-paw me-2"></i>
                        {{ mascota.nombre }} • Registro médico completo
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="card-actions">
                        <a href="{% url 'clientes:detalle_mascota' mascota.pk %}" class="btn-modern btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Volver
                        </a>
                        <a href="{% url 'consultas:historia_clinica_imprimible_v2' mascota.pk %}" target="_blank" class="btn-modern btn-secondary">
                            Imprimir
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna de la foto -->
        <div class="col-md-4 mb-4">
            <div class="photo-card slide-up">
                <h5 class="mb-3">
                    <i class="fas fa-camera me-2 text-secondary"></i>
                    Foto de {{ mascota.nombre }}
                </h5>
                {% if mascota.foto %}
                    <img src="{{ mascota.foto.url }}" alt="{{ mascota.nombre }}" class="img-fluid pet-photo">
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-image empty-state-icon"></i>
                        <h6>Sin foto</h6>
                        <p class="text-muted mb-0">No hay foto disponible</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Columna principal -->
        <div class="col-md-8">
            <!-- Información General -->
            <div class="detail-card slide-up">
                <div class="card-header-modern">
                    <h5 class="card-title-modern">
                        <i class="fas fa-info-circle"></i>
                        Información General
                    </h5>
                </div>
                <div class="card-body-modern">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-paw"></i>
                                Nombre
                            </div>
                            <div class="info-value">{{ mascota.nombre }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-user"></i>
                                Propietario
                            </div>
                            <div class="info-value">{{ mascota.cliente.nombre }} {{ mascota.cliente.apellido }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-dna"></i>
                                Especie
                            </div>
                            <div class="info-value">{{ mascota.especie }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-tags"></i>
                                Raza
                            </div>
                            <div class="info-value">{{ mascota.raza }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-venus-mars"></i>
                                Sexo
                            </div>
                            <div class="info-value">{{ mascota.get_sexo_display }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-birthday-cake"></i>
                                Fecha de Nacimiento
                            </div>
                            <div class="info-value">{{ mascota.fecha_nacimiento|date:'d/m/Y' }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-heartbeat"></i>
                                Estado
                            </div>
                            <div class="info-value">
                                {% if mascota.activa %}
                                    <span class="status-badge status-active">
                                        <i class="fas fa-check-circle"></i>
                                        Activa
                                    </span>
                                {% else %}
                                    <span class="status-badge status-inactive">
                                        <i class="fas fa-times-circle"></i>
                                        Inactiva
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial Médico -->
    <div class="detail-card slide-up">
        <div class="card-header-modern bg-primary-custom">
            <h5 class="card-title-modern">
                <i class="fas fa-clock"></i>
                Historial Médico Completo
            </h5>
        </div>
        <div class="card-body-modern">
            <div class="timeline">
                <!-- Consultas -->
                {% for consulta in consultas %}
                <div class="timeline-item timeline-consultation">
                    <div class="timeline-card">
                        <div class="timeline-card-header consultation">
                            <div>
                                <strong>
                                    <i class="fas fa-stethoscope me-2"></i>
                                    Consulta - {{ consulta.cita.fecha|date:'d/m/Y H:i' }}
                                </strong>
                                {% if consulta.es_eutanasia %}
                                    <span class="status-badge ms-2" style="background: rgba(0,0,0,0.2); color: white;">
                                        <i class="fas fa-heart"></i>
                                        Eutanasia
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="timeline-card-body">
                            <div class="timeline-info-grid">
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Motivo</div>
                                    <div class="timeline-info-value">{{ consulta.cita.motivo }}</div>
                                </div>
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Diagnóstico</div>
                                    <div class="timeline-info-value">{{ consulta.diagnostico }}</div>
                                </div>
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Tratamiento</div>
                                    <div class="timeline-info-value">{{ consulta.tratamiento }}</div>
                                </div>
                                {% if consulta.notas %}
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Notas</div>
                                    <div class="timeline-info-value">{{ consulta.notas }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert-modern alert-info-modern">
                    <i class="fas fa-info-circle"></i>
                    No hay consultas registradas para esta mascota.
                </div>
                {% endfor %}

                <!-- Vacunas Aplicadas -->
                {% for vacuna in vacunas_aplicadas %}
                <div class="timeline-item timeline-vaccine">
                    <div class="timeline-card">
                        <div class="timeline-card-header vaccine">
                            <strong>
                                <i class="fas fa-syringe me-2"></i>
                                Vacuna - {{ vacuna.fecha_aplicacion|date:'d/m/Y' }}
                            </strong>
                        </div>
                        <div class="timeline-card-body">
                            <div class="timeline-info-grid">
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Vacuna</div>
                                    <div class="timeline-info-value">{{ vacuna.vacuna.nombre }}</div>
                                </div>
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Próxima aplicación</div>
                                    <div class="timeline-info-value">{{ vacuna.fecha_proxima|date:'d/m/Y'|default:'N/A' }}</div>
                                </div>
                                {% if vacuna.observaciones %}
                                <div class="timeline-info-item" style="grid-column: 1 / -1;">
                                    <div class="timeline-info-label">Observaciones</div>
                                    <div class="timeline-info-value">{{ vacuna.observaciones }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert-modern alert-info-modern">
                    <i class="fas fa-syringe"></i>
                    No hay vacunas registradas para esta mascota.
                </div>
                {% endfor %}

                <!-- Productos Aplicados -->
                {% for producto in productos_aplicados %}
                <div class="timeline-item timeline-product">
                    <div class="timeline-card">
                        <div class="timeline-card-header product">
                            <strong>
                                <i class="fas fa-pills me-2"></i>
                                Producto Aplicado - {{ producto.fecha_aplicacion|date:'d/m/Y' }}
                            </strong>
                        </div>
                        <div class="timeline-card-body">
                            <div class="timeline-info-grid">
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Producto</div>
                                    <div class="timeline-info-value">{{ producto.producto.nombre }}</div>
                                </div>
                                <div class="timeline-info-item">
                                    <div class="timeline-info-label">Próxima aplicación</div>
                                    <div class="timeline-info-value">{{ producto.fecha_proxima|date:'d/m/Y'|default:'N/A' }}</div>
                                </div>
                                {% if producto.observaciones %}
                                <div class="timeline-info-item" style="grid-column: 1 / -1;">
                                    <div class="timeline-info-label">Observaciones</div>
                                    <div class="timeline-info-value">{{ producto.observaciones }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert-modern alert-info-modern">
                    <i class="fas fa-pills"></i>
                    No hay productos aplicados registrados para esta mascota.
                </div>
                {% endfor %}

                <!-- Imágenes Diagnósticas -->
                {% if imagenes_diagnosticas %}
                <div class="timeline-item timeline-image">
                    <div class="timeline-card">
                        <div class="timeline-card-header image">
                            <div>
                                <strong>
                                    <i class="fas fa-images me-2"></i>
                                    Imágenes Diagnósticas ({{ imagenes_diagnosticas.count }})
                                </strong>
                            </div>
                            <div class="btn-group-modern">
                                <a href="{% url 'consultas:lista_imagenes_diagnosticas_mascota' mascota.id %}" class="btn-sm-modern btn-light-modern">
                                    <i class="fas fa-list"></i>Ver Todas
                                </a>
                                <a href="{% url 'consultas:crear_imagen_diagnostica_mascota' mascota.id %}" class="btn-sm-modern btn-light-modern">
                                    <i class="fas fa-plus"></i>Nueva
                                </a>
                            </div>
                        </div>
                        <div class="timeline-card-body">
                            <div class="images-grid">
                                {% for imagen in imagenes_diagnosticas|slice:":6" %}
                                <div class="image-item">
                                    {% if imagen.archivo %}
                                        {% if imagen.archivo.name|lower|slice:"-4:" == ".pdf" %}
                                            <div class="file-icon text-danger">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <small class="text-muted">PDF</small>
                                        {% elif imagen.archivo.name|lower|slice:"-4:" == ".doc" or imagen.archivo.name|lower|slice:"-5:" == ".docx" %}
                                            <div class="file-icon text-primary">
                                                <i class="fas fa-file-word"></i>
                                            </div>
                                            <small class="text-muted">DOC</small>
                                        {% else %}
                                            <img src="{{ imagen.archivo.url }}" alt="Imagen diagnóstica" class="img-fluid image-preview">
                                        {% endif %}
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="text-muted d-block">{{ imagen.fecha|date:"d/m/Y" }}</small>
                                        <small class="text-muted">{{ imagen.descripcion|truncatechars:30 }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if imagenes_diagnosticas.count > 6 %}
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    Mostrando las 6 más recientes de {{ imagenes_diagnosticas.count }} imágenes.
                                    <a href="{% url 'consultas:lista_imagenes_diagnosticas_mascota' mascota.id %}" class="text-primary">Ver todas</a>
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="timeline-item timeline-image">
                    <div class="timeline-card">
                        <div class="timeline-card-header image">
                            <strong>
                                <i class="fas fa-images me-2"></i>
                                Imágenes Diagnósticas
                            </strong>
                        </div>
                        <div class="timeline-card-body">
                            <div class="empty-state">
                                <i class="fas fa-images empty-state-icon"></i>
                                <h6>No hay imágenes diagnósticas</h6>
                                <p class="text-muted mb-3">No se han registrado imágenes para esta mascota</p>
                                <a href="{% url 'consultas:crear_imagen_diagnostica_mascota' mascota.id %}" class="btn-modern btn-primary">
                                    <i class="fas fa-plus"></i>
                                    Subir Primera Imagen
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Mensaje cuando no hay historial -->
                {% if not consultas and not vacunas_aplicadas and not productos_aplicados %}
                <div class="empty-state">
                    <i class="fas fa-file-medical empty-state-icon"></i>
                    <h4>Historia Clínica Sin Registros</h4>
                    <p class="text-muted mb-3">Esta mascota aún no tiene registros médicos en su historia clínica.</p>
                    <div class="btn-group-modern">
                        <a href="{% url 'citas:crear_cita' %}" class="btn-modern btn-primary">
                            <i class="fas fa-plus"></i>
                            Programar Cita
                        </a>
                        <a href="{% url 'consultas:crear_imagen_diagnostica_mascota' mascota.id %}" class="btn-modern btn-secondary">
                            <i class="fas fa-images"></i>
                            Subir Imagen
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sección de Estadísticas Rápidas -->
    <div class="detail-card slide-up">
        <div class="card-header-modern bg-info-custom">
            <h5 class="card-title-modern">
                <i class="fas fa-chart-bar"></i>
                Resumen de Historia Clínica
            </h5>
        </div>
        <div class="card-body-modern">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-stethoscope"></i>
                        Total Consultas
                    </div>
                    <div class="info-value">{{ consultas|length }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-syringe"></i>
                        Vacunas Aplicadas
                    </div>
                    <div class="info-value">{{ vacunas_aplicadas|length }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-pills"></i>
                        Productos Aplicados
                    </div>
                    <div class="info-value">{{ productos_aplicados|length }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-images"></i>
                        Imágenes Diagnósticas
                    </div>
                    <div class="info-value">{{ imagenes_diagnosticas.count|default:0 }}</div>
                </div>
                
                {% if consultas %}
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt"></i>
                        Última Consulta
                    </div>
                    <div class="info-value">{{ consultas.first.cita.fecha|date:'d/m/Y' }}</div>
                </div>
                {% endif %}
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-clock"></i>
                        Edad Actual
                    </div>
                    <div class="info-value">
                        <span id="edad-mascota" data-fecha-nacimiento="{{ mascota.fecha_nacimiento|date:'Y-m-d' }}">
                            Calculando...
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
// Función para calcular la edad de la mascota
function calcularEdad() {
    const fechaNacimiento = document.getElementById('edad-mascota').dataset.fechaNacimiento;
    if (fechaNacimiento) {
        const nacimiento = new Date(fechaNacimiento);
        const hoy = new Date();
        
        let años = hoy.getFullYear() - nacimiento.getFullYear();
        let meses = hoy.getMonth() - nacimiento.getMonth();
        
        if (meses < 0) {
            años--;
            meses += 12;
        }
        
        if (hoy.getDate() < nacimiento.getDate()) {
            meses--;
            if (meses < 0) {
                años--;
                meses += 12;
            }
        }
        
        let edadTexto = '';
        if (años > 0) {
            edadTexto += años + (años === 1 ? ' año' : ' años');
        }
        if (meses > 0) {
            if (edadTexto) edadTexto += ', ';
            edadTexto += meses + (meses === 1 ? ' mes' : ' meses');
        }
        
        if (!edadTexto) {
            const dias = Math.floor((hoy - nacimiento) / (1000 * 60 * 60 * 24));
            edadTexto = dias + (dias === 1 ? ' día' : ' días');
        }
        
        document.getElementById('edad-mascota').textContent = edadTexto;
    }
}

// Función para mejorar la experiencia de impresión
function configurarImpresion() {
    const mediaQueryList = window.matchMedia('print');
    mediaQueryList.addListener(function(mql) {
        if (mql.matches) {
            // Antes de imprimir
            document.body.classList.add('printing');
        } else {
            // Después de imprimir
            document.body.classList.remove('printing');
        }
    });
}

// Función para agregar efectos de hover en tarjetas
function inicializarEfectos() {
    const tarjetas = document.querySelectorAll('.detail-card, .timeline-card');
    
    tarjetas.forEach(tarjeta => {
        tarjeta.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        tarjeta.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

// Función para animar elementos al hacer scroll
function animarAlScroll() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('slide-up');
            }
        });
    }, observerOptions);
    
    // Observar elementos que no tienen la clase slide-up
    const elementos = document.querySelectorAll('.timeline-item:not(.slide-up)');
    elementos.forEach(elemento => {
        observer.observe(elemento);
    });
}

// Función para manejar imágenes con lightbox básico
function configurarImagenes() {
    const imagenes = document.querySelectorAll('.image-preview, .pet-photo');
    
    imagenes.forEach(img => {
        img.addEventListener('click', function() {
            // Crear lightbox simple
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const imgClone = this.cloneNode();
            imgClone.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 0 30px rgba(255,255,255,0.3);
            `;
            
            overlay.appendChild(imgClone);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
        });
        
        img.style.cursor = 'pointer';
        img.title = 'Clic para ampliar';
    });
}

// Inicializar todo cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    calcularEdad();
    configurarImpresion();
    inicializarEfectos();
    animarAlScroll();
    configurarImagenes();
    
    // Actualizar edad cada minuto (por si alguien deja la página abierta mucho tiempo)
    setInterval(calcularEdad, 60000);
});

// Función adicional para ordenar timeline por fecha (si es necesario)
function ordenarTimeline() {
    const timeline = document.querySelector('.timeline');
    const items = Array.from(timeline.querySelectorAll('.timeline-item'));
    
    // Esta función estaría disponible para uso futuro si necesitas ordenar dinámicamente
    items.sort((a, b) => {
        const fechaA = a.dataset.fecha || '1970-01-01';
        const fechaB = b.dataset.fecha || '1970-01-01';
        return new Date(fechaB) - new Date(fechaA);
    });
    
    items.forEach(item => timeline.appendChild(item));
}
</script>
{% endblock %}